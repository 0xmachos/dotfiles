# ~/.shh/config
# ssh_config(5)
# https://man.openbsd.org/ssh_config

# https://stribika.github.io/2015/01/04/secure-secure-shell.html 

# Configuration values are only changed the first time they are set
# Host-specific definitions should be at the beginning and defaults at the end

Include ~/.ssh/.extra_ssh

Host *

    IdentityAgent ~/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/socket.ssh
    IdentitiesOnly yes
    VisualHostKey yes
    PubkeyAuthentication yes
    HashKnownHosts yes
    # ssh-keygen -R hostname

    UseRoaming no
    # CVE-2016-0777

    UseKeychain yes
    # Tell the system to search for key passphrases in the user's keychain 
    # When passphrase is provided and is correct store it in the keychain
    # https://developer.apple.com/library/content/technotes/tn2449/_index.html

    ForwardAgent no
    # Do not allow the connection to the authentication agent to be forwarded to the remote machine
    # http://www.unixwiz.net/techtips/ssh-agent-forwarding.html#fwd

    # Cryptography

    # For values that end with @openssh.com these are algorithms defined by OpenSSH that 
    #  deviate in some way to the published SSH protocol or algorithm RFC
    #  See: https://security.stackexchange.com/a/231117
    #  See: https://www.rfc-editor.org/rfc/rfc4251#section-6
    #  See: https://github.com/openssh/openssh-portable/blob/V_8_2/PROTOCOL

    # Client                                         Server
    #   |                                               |
    #   |  1. Key Exchange (KexAlgorithms)              |
    #   |  ─────────────────────────────────────────►   |
    #   |     Establish shared secret                   |
    #   |                                               |
    #   |  2. Server Identity (HostKeyAlgorithms)       |
    #   |  ◄─────────────────────────────────────────   |
    #   |     Server proves it's idetity                |
    #   |                                               |
    #   |  3. Encrypted Channel (Ciphers + MACs)        |
    #   |  ◄────────────────────────────────────────►   |
    #   |     All traffic now encrypted                 |
    #   |                                               |
    #   |  4. Client Auth (PubkeyAcceptedAlgorithms)    |
    #   |  ─────────────────────────────────────────►   |
    #   |     You prove your identity                   |
    #   |                                               |

    KexAlgorithms mlkem768x25519-sha256,sntrup761x25519-sha512@openssh.com,curve25519-sha256
    # Allow Hybrid PQ (ML-KEM or NTRU Prime + X25519) with classical X25519 as fallback

    HostKeyAlgorithms ssh-ed25519
    # Allow only ed25519
    # TODO: Add ssh-mldsa-87 when it lands

    Ciphers chacha20-poly1305@openssh.com
    # Only use AEAD cipher chacha20-poly1305
    # Stream cipher ChaCha20 & MAC Poly1305 
    # When using AES-GCM or EtM the SSH protocol does not encrypt message sizes,
    #   this allows some traffic analysis without decrypting the data
    #   See: http://blog.djm.net.au/2013/11/chacha20-and-poly1305-in-openssh.html
    # chacha20-poly1305 is fast in software, which is an advantage on hardware that lacks AES-NI

    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com
    # Allow only use encrypt then mac (etm) MACs: HMAC-SHA2-512/256 or UMAC-128
    #   https://crypto.stackexchange.com/a/56432
    # This is defence in depth, only cipher is chacha20-poly1305, built in MAC Poly1305
    #  See: https://github.com/openssh/openssh-portable/blob/V_8_2/PROTOCOL.chacha20poly1305
    # Included incase I add another cipher, other than chacha20-poly1305, above to connect
    #  to a system that does not support chacha20-poly1305

    PubkeyAcceptedAlgorithms ssh-ed25519,ecdsa-sha2-nistp256
    # ed25519 is the preferred key type
    # ECDSA for Secretive/ Secure Enclave generated keys
    # TODO: Add ssh-mldsa-87 when it lands
